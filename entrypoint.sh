#!/bin/bash

# Source and Target Environment Variables
POSTGRES_BACKUP_RESTORE_SOURCE_DB_HOST=$POSTGRES_BACKUP_RESTORE_SOURCE_DB_HOST
POSTGRES_BACKUP_RESTORE_SOURCE_DB_PORT=$POSTGRES_BACKUP_RESTORE_SOURCE_DB_PORT
POSTGRES_BACKUP_RESTORE_SOURCE_USER=$POSTGRES_BACKUP_RESTORE_SOURCE_USER
POSTGRES_BACKUP_RESTORE_SOURCE_PASSWORD=$POSTGRES_BACKUP_RESTORE_SOURCE_PASSWORD
POSTGRES_BACKUP_RESTORE_SOURCE_DB_NAME=$POSTGRES_BACKUP_RESTORE_SOURCE_DB_NAME

POSTGRES_BACKUP_RESTORE_TARGET_DB_HOST=$POSTGRES_BACKUP_RESTORE_TARGET_DB_HOST
POSTGRES_BACKUP_RESTORE_TARGET_DB_PORT=$POSTGRES_BACKUP_RESTORE_TARGET_DB_PORT
POSTGRES_BACKUP_RESTORE_TARGET_USER=$POSTGRES_BACKUP_RESTORE_TARGET_USER
POSTGRES_BACKUP_RESTORE_TARGET_PASSWORD=$POSTGRES_BACKUP_RESTORE_TARGET_PASSWORD
POSTGRES_BACKUP_RESTORE_TARGET_DB_NAME=$POSTGRES_BACKUP_RESTORE_TARGET_DB_NAME

# Dump the source database
echo "dumping database ..."
PGPASSWORD=$POSTGRES_BACKUP_RESTORE_SOURCE_PASSWORD pg_dump -h $POSTGRES_BACKUP_RESTORE_SOURCE_DB_HOST -p $POSTGRES_BACKUP_RESTORE_SOURCE_DB_PORT -U $POSTGRES_BACKUP_RESTORE_SOURCE_USER -d $POSTGRES_BACKUP_RESTORE_SOURCE_DB_NAME > /tmp/source_dump.sql

dos2unix /tmp/source_dump.sql
# Restore into the target database
echo "restoring database ..."
PGPASSWORD=$POSTGRES_BACKUP_RESTORE_TARGET_PASSWORD psql -h $POSTGRES_BACKUP_RESTORE_TARGET_DB_HOST -p $POSTGRES_BACKUP_RESTORE_TARGET_DB_PORT -U $POSTGRES_BACKUP_RESTORE_TARGET_USER -d $POSTGRES_BACKUP_RESTORE_TARGET_DB_NAME -f /tmp/source_dump.sql